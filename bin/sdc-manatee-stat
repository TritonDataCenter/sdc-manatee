#!/bin/bash

#
# sdc-manatee-stat: display the status of all sdc manatee shards
#

if [[ -n "$TRACE" ]]; then
    export PS4='[\D{%FT%TZ}] ${BASH_SOURCE}:${LINENO}: ${FUNCNAME[0]:+${FUNCNAME[0]}(): }'
    set -o xtrace
fi
set -o errexit
set -o pipefail

function usage() {
cat << HERE
usage: $0

Display the status of manatee shards.

OPTIONS:
-h Show this message
-v Verbose
HERE
}

while getopts "hs:v" OPTION
do
    case $OPTION in 
        h)
            usage
            exit 1
            ;;
        v)
            set -o xtrace
            ;;
        ?)
            usage
            exit
            ;;
    esac
done

# XXX replace the vmadm and zlogin with sdc-role list and sdc-oneachnode once
# moray supports readonly mode on manatee errors. presently all of the moray
# dependent tools fail since there's no manatee. We will require this when
# manatee is x-dc and we can no longer find all manatee instances via vmadm |
# grep

# find a sdc manatee zone
MANATEE_ZONE_ID=$(vmadm list | grep manatee | head -1 | tr -s ' ' | \
    cut -d ' ' -f1)
[[ $? -eq 0 ]] || fatal "Unable to retrieve a manatee zone from sdc-role list"

zlogin $MANATEE_ZONE_ID "source ~/.bashrc; manatee-stat"
